<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RSE Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto&display=swap" rel="stylesheet">
    
    <!-- Custom Stylesheets -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="dashboard.css">
    
    <!-- Inline Styles for Initial Setup (Removed NES-Style Activity Feed Inline) -->
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">The Service Exchange</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="grab_job.html">Grab Jobs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="api_docs.html">API Docs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="nearby.html">Nearby Services</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="bounty.html">Demo Apps</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="dashboard.html" aria-current="page">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">About</a>
                    </li>
                </ul>
                <button id="chatButton" class="btn btn-outline-light btn-sm ms-2" style="display: none;" onclick="showChat()">ðŸ’¬ Inbox</button>
                <button id="bulletinButton" class="btn btn-outline-light btn-sm ms-2" style="display: none;" onclick="showBulletin()">ðŸ“¢ Community</button>
                <div id="accountDropdown" class="account-dropdown ms-3" style="display: none;">
                    <button class="account-btn">
                        <span id="accountUsername">Account</span> â–¼
                    </button>
                    <div class="account-window">
                        <div class="account-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0" id="accountDisplayName">Loading...</h5>
                                <button class="logout-btn" onclick="logout()">Logout</button>
                            </div>
                            <div class="reputation-display">
                                <span class="star-rating" id="starDisplay">â˜…â˜…â˜…â˜…â˜…</span>
                                <span id="ratingText">4.5 (12 ratings)</span>
                            </div>
                        </div>
                        <div class="account-section">
                            <h6>Outstanding Requests</h6>
                            <div class="loading-spinner" id="bidsLoading">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <span class="ms-2">Loading requests...</span>
                            </div>
                            <div id="outstandingBids">
                                <p class="text-muted mb-0">No outstanding requests</p>
                            </div>
                        </div>
                        <div class="account-section">
                            <h6>Active Services</h6>
                            <div class="loading-spinner" id="activeJobsLoading">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <span class="ms-2">Loading active services...</span>
                            </div>
                            <div id="activeJobs">
                                <p class="text-muted mb-0">No active services</p>
                            </div>
                        </div>
                        <div class="account-section">
                            <h6>Recent Completed Services</h6>
                            <div class="loading-spinner" id="jobsLoading">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <span class="ms-2">Loading services...</span>
                            </div>
                            <div id="completedJobs">
                                <p class="text-muted mb-0">No completed services</p>
                            </div>
                        </div>
                    </div>
                </div>
                <button id="loginButton" class="btn btn-light ms-3" onclick="showAuth()">Get Started</button>
            </div>
        </div>
    </nav>

    <header style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px 0; margin-bottom: 30px;">
        <div class="container">
            <h1 style="color: white; text-shadow: 0 2px 6px rgba(0,0,0,0.3);">RSE Activity Dashboard</h1>
            <div class="style-picker">
                <label for="theme-select" style="color: white;">Style:</label>
                <select id="theme-select" class="form-select" style="width: auto; display: inline-block;">
                    <option value="default">Default</option>
                    <option value="aztec-wrestler">Aztec Wrestler</option>
                    <option value="tmnt">TMNT</option>
                    <option value="icewind-dale">Icewind Dale</option>
                    <option value="classic-snes">Classic SNES</option>
                    <option value="cyberninja">CyberNinja</option>
                </select>
            </div>
        </div>
    </header>
    <main>
        <div class="container dashboard-container">
            <div class="dashboard-grid">
                <div class="map-container">
                    <div id="map"></div>
                    <div class="map-controls">
                        <label><input type="checkbox" id="show-bids" checked> Show Bids</label>
                        <label><input type="checkbox" id="show-won-jobs" checked> Show Won Jobs</label>
                        <label><input type="checkbox" id="show-completed-jobs" checked> Show Completed Jobs</label>
                    </div>
                </div>
                <div class="console-container">
                    <div class="activity-feed">
                        <h2>Activity Log</h2>
                        <div id="activity-log"></div>
                    </div>
                    <div class="button-container">
                        <button id="grab-job">Grab Job</button>
                        <button id="submit-bid">Submit Bid</button>
                    </div>
                    <div id="submission-data">
                        <!-- Submission data will appear here -->
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <div class="modal fade" id="authModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Get Started</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="authError" class="error-message" style="display: none;"></div>
                    <ul class="nav nav-tabs mb-3">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#login">Login</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#register">Register</a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane active" id="login">
                            <form id="loginForm">
                                <div class="mb-3">
                                    <input type="text" class="form-control" placeholder="Username" id="loginUsername" required>
                                </div>
                                    <div class="mb-3">
                                    <input type="password" class="form-control" placeholder="Password" id="loginPassword" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100" id="loginSubmitBtn">Login</button>
                            </form>
                        </div>
                        <div class="tab-pane" id="register">
                            <form id="registerForm">
                                <div class="mb-3">
                                    <input type="text" class="form-control" placeholder="Username" id="regUsername" required>
                                </div>
                                <div class="mb-3">
                                    <input type="password" class="form-control" placeholder="Password (min 8 chars)" id="regPassword" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100" id="registerSubmitBtn">Register</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="chatModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ðŸ’¬ Inbox</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-4">
                            <h6>Conversations</h6>
                            <div class="chat-inbox" id="chatInbox">
                                <div class="loading-spinner" id="conversationsLoading">
                                    <div class="spinner-border spinner-border-sm" role="status"></div>
                                    <span class="ms-2">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-8">
                            <div id="conversationView" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 id="currentConversationUser">Select a conversation</h6>
                                    <button class="btn btn-sm btn-primary" onclick="showNewMessageForm()">New Message</button>
                                </div>
                                <div class="message-history" id="messageHistory"></div>
                                <form id="replyForm" style="display: none;">
                                    <div class="input-group">
                                        <input type="text" class="form-control" placeholder="Type your reply..." id="replyMessage" required>
                                        <button type="submit" class="btn btn-primary">Send</button>
                                    </div>
                                </form>
                            </div>
                            <div id="newMessageForm" style="display: none;">
                                <h6>New Message</h6>
                                <form id="chatForm">
                                    <div class="mb-3">
                                        <input type="text" class="form-control" placeholder="Recipient username" id="chatRecipient" required>
                                    </div>
                                    <div class="mb-3">
                                        <textarea class="form-control" rows="3" placeholder="Your message" id="chatMessage" required></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <input type="text" class="form-control" placeholder="Job ID (optional)" id="chatJobId">
                                        <small class="text-muted">Link this message to a specific job</small>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary">Send Message</button>
                                        <button type="button" class="btn btn-secondary" onclick="hideNewMessageForm()">Cancel</button>
                                    </div>
                                </form>
                            </div>
                            <div id="chatPlaceholder">
                                <div class="text-center text-muted p-4">
                                    <p>Select a conversation to view messages or click "New Message" to start chatting.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="bulletinModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ðŸ“¢ Community Bulletin</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>Recent Posts</h6>
                        <button class="btn btn-sm btn-primary" onclick="showNewPostForm()">New Post</button>
                    </div>
                    <div id="bulletinFeed" class="bulletin-feed">
                        <div class="loading-spinner" id="bulletinLoading">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <span class="ms-2">Loading posts...</span>
                        </div>
                    </div>
                    <div id="newPostForm" style="display: none;" class="mt-3 p-3 border rounded">
                        <h6>Create New Post</h6>
                        <form id="bulletinForm">
                            <div class="mb-3">
                                <input type="text" class="form-control" placeholder="Post title" id="bulletinTitle" required>
                            </div>
                            <div class="mb-3">
                                <select class="form-control" id="bulletinCategory">
                                    <option value="general">General</option>
                                    <option value="announcement">Announcement</option>
                                    <option value="question">Question</option>
                                    <option value="offer">Service Offer</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <textarea class="form-control" rows="4" placeholder="Post content" id="bulletinContent" required></textarea>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">Post to Bulletin</button>
                                <button type="button" class="btn btn-secondary" onclick="hideNewPostForm()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="script.js"></script>
    <script>
        // Theme Switching Logic
        const themeSelect = document.getElementById('theme-select');
        themeSelect.addEventListener('change', (e) => {
            document.body.className = ''; // Reset any existing theme classes
            if (e.target.value !== 'default') {
                document.body.classList.add(`theme-${e.target.value}`);
            }
        });

        // Initialize the map
        const map = L.map('map').setView([40.7128, -74.0060], 13); // Default to New York City

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Geolocation: Center map on user's location if permission granted
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLon = position.coords.longitude;
                    map.setView([userLat, userLon], 13);
                    L.marker([userLat, userLon]).addTo(map)
                        .bindPopup("You are here").openPopup();
                },
                (error) => {
                    console.warn(`Geolocation error (${error.code}): ${error.message}`);
                    // Optional: You can inform the user that default location is used
                }
            );
        } else {
            console.warn("Geolocation is not supported by this browser.");
        }

        // Activity Log Element
        const activityLog = document.getElementById('activity-log');

        // Predefined Service Requests and Robot Names
        const serviceRequests = [
            // Original Services (20)
            "Aerial photography of solar farm",
            "Autonomous lawn mowing for golf course",
            "Underwater pipeline inspection",
            "Rooftop HVAC maintenance",
            "Traffic flow optimization",
            "Agricultural crop spraying",
            "Search and rescue in wilderness",
            "Warehouse inventory management",
            "Construction site surveying",
            "Automated parking assistance",
            "Wildlife population monitoring",
            "Waste sorting and recycling",
            "Building facade cleaning",
            "Autonomous security patrol",
            "Tree health assessment in urban areas",
            "Package delivery to remote locations",
            "Automated harvesting of fruits",
            "Snow removal from solar panels",
            "Disaster area assessment",
            "Underground utility mapping",
            // New Services: Food and Grocery Delivery (10)
            "Autonomous grocery delivery to residential areas",
            "Robotic meal kit preparation and delivery",
            "Drone-based fast food delivery",
            "Automated fresh produce distribution",
            "Contactless restaurant order pickup and delivery",
            "Smart fridge restocking service",
            "Robotic coffee and snack vending",
            "Autonomous catering service for events",
            "Drone delivery of emergency food supplies",
            "Automated bakery goods distribution",
            // New Services: Human Services (15)
            "Robotic elder care assistance with daily tasks",
            "Automated medication delivery and reminders",
            "Virtual reality entertainment for seniors",
            "Robotic physical therapy support",
            "Autonomous patient transport within hospitals",
            "AI-driven mental health companion services",
            "Robotic childcare assistance in daycare centers",
            "Automated home safety monitoring for elderly",
            "Robotic guide for visually impaired individuals",
            "AI-powered language tutoring for children",
            "Robotic pet therapy for hospital patients",
            "Automated wheelchair navigation assistance",
            "Robotic music therapy sessions",
            "AI-driven social engagement for isolated individuals",
            "Robotic hygiene assistance for disabled persons",
            // New Services: Unique/Creative Categories (15)
            "Autonomous urban art installation maintenance",
            "Robotic 3D printing for on-site repairs",
            "Drone-based live event streaming",
            "AI-driven personalized gift delivery",
            "Robotic archaeological site scanning",
            "Automated vertical garden maintenance",
            "Drone swarm light show coordination",
            "Robotic museum exhibit maintenance",
            "AI-powered waste-to-art conversion",
            "Autonomous beekeeping and hive monitoring",
            "Robotic coral reef restoration",
            "Drone-based air quality monitoring",
            "Automated public park cleanup",
            "Robotic historical site preservation",
            "AI-driven interactive public art installations"
        ];

        const robotNames = [
            "SkyEye-X1", "TurfMaster 3000", "AquaProbe Delta", "ClimboCraft Pro", "UrbanFlow AI",
            "CropCare Quad", "WildernessScout", "StockBot Express", "GeoMapper Plus", "ParkAssist 2.0",
            "EcoTracker", "RecycleMatic", "SkyWash Ultra", "SecuriGuard X3", "ArborHealth Scanner",
            "DeliverEagle", "FruitHarvester Pro", "SnowSweep Bot", "DisasterRecon", "SubTerra Mapper",
            "MarineSentry", "SkySprayer Eco", "RoadMender AI", "PowerLine Inspector", "FireFighter Assist"
        ];

        // Function to get a random location within current map bounds
        function getRandomLocation() {
            const bounds = map.getBounds();
            const southWest = bounds.getSouthWest();
            const northEast = bounds.getNorthEast();
            const lat = Math.random() * (northEast.lat - southWest.lat) + southWest.lat;
            const lon = Math.random() * (northEast.lng - southWest.lng) + southWest.lng;
            return [lat, lon];
        }

        // Function to create a custom Leaflet icon
        function createCustomIcon(color) {
            return L.divIcon({
                className: 'custom-icon',
                html: `<div style="background-color:${color};width:12px;height:12px;border-radius:50%; border: 2px solid white;"></div>`,
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            });
        }

        // Define different icons for services, completed jobs, and robots
        const serviceIcon = createCustomIcon('blue');
        const completedJobIcon = createCustomIcon('green');
        const robotIcon = createCustomIcon('red');

        // Function to add a simulated activity
        function addSimulatedActivity() {
            // Determine activity type based on probabilities
            const rand = Math.random();
            let activityType;
            if (rand < 0.6) {
                activityType = 'service';
            } else if (rand < 0.8) {
                activityType = 'completed';
            } else {
                activityType = 'robot';
            }

            // Get a random location within current map bounds
            const [lat, lon] = getRandomLocation();
            const timestamp = new Date().toLocaleTimeString();

            let logEntry, markerIcon, popupContent;

            switch(activityType) {
                case 'service':
                    const service = serviceRequests[Math.floor(Math.random() * serviceRequests.length)];
                    logEntry = `[${timestamp}] Simulated service request: ${service} (simulated) at (${lat.toFixed(4)}, ${lon.toFixed(4)})`;
                    markerIcon = serviceIcon;
                    popupContent = `Service: ${service} (simulated)`;
                    break;
                case 'completed':
                    const completedService = serviceRequests[Math.floor(Math.random() * serviceRequests.length)];
                    logEntry = `[${timestamp}] Simulated completed job: ${completedService} (simulated) at (${lat.toFixed(4)}, ${lon.toFixed(4)})`;
                    markerIcon = completedJobIcon;
                    popupContent = `Completed Job: ${completedService} (simulated)`;
                    break;
                case 'robot':
                    const robot = robotNames[Math.floor(Math.random() * robotNames.length)];
                    logEntry = `[${timestamp}] Simulated robot location: ${robot} (simulated) at (${lat.toFixed(4)}, ${lon.toFixed(4)})`;
                    markerIcon = robotIcon;
                    popupContent = `Robot: ${robot} (simulated)`;
                    break;
            }

            // Add the log entry to the activity feed
            const logItem = document.createElement('div');
            logItem.textContent = logEntry;
            activityLog.appendChild(logItem);

            // Scroll to the bottom to show the latest entry
            activityLog.scrollTop = activityLog.scrollHeight;

            // Limit the activity log to the latest 100 entries
            if (activityLog.children.length > 100) {
                activityLog.removeChild(activityLog.firstChild);
            }

            // Add a marker to the map with a popup
            L.marker([lat, lon], {icon: markerIcon}).addTo(map)
                .bindPopup(popupContent);
        }

        // Start adding simulated activities every 2 seconds
        setInterval(addSimulatedActivity, 2000);

        // Optional: Adjust simulated activities when the map view changes (e.g., on zoom or pan)
        // This ensures that new activities are always within the current view
        map.on('moveend', () => {
            // You can implement additional logic here if needed when the map view changes
        });
    </script>
</body>
</html>
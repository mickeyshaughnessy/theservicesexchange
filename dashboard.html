<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RSE Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .simulation-toggle {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 15px;
        }
        .simulation-toggle label {
            font-weight: 600;
            color: #856404;
        }
        .simulation-badge {
            background: #ffc107;
            color: #000;
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }
        .simulated-section {
            border: 2px dashed #ffc107;
            border-radius: 8px;
            padding: 15px;
            background: #fffef5;
            margin-top: 15px;
        }
        .simulated-section h5 {
            color: #856404;
        }
        .real-data-section {
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 15px;
            background: #f8fff8;
        }
        .real-data-section h5 {
            color: #155724;
        }
        .real-badge {
            background: #28a745;
            color: #fff;
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }
        #simulatedSection {
            max-height: 300px;
            overflow: hidden;
        }
        #simulated-activity-log {
            max-height: 180px;
            overflow-y: auto;
            font-size: 0.85rem;
            background: #fffbea;
            padding: 10px;
            border-radius: 4px;
        }
        #simulated-activity-log div {
            padding: 4px 0;
            border-bottom: 1px solid #ffe69c;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">The Service Exchange</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="api_docs.html">API Docs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="bounty.html">Demo Apps</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="dashboard.html" aria-current="page">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">About</a>
                    </li>
                </ul>
                <button id="chatButton" class="btn btn-outline-light btn-sm ms-2" style="display: none;" onclick="showChat()">Inbox</button>
                <button id="bulletinButton" class="btn btn-outline-light btn-sm ms-2" style="display: none;" onclick="showBulletin()">Community</button>
                <div id="accountDropdown" class="account-dropdown ms-3" style="display: none;">
                    <button class="account-btn">
                        <span id="accountUsername">Account</span> â–¼
                    </button>
                    <div class="account-window">
                        <div class="account-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0" id="accountDisplayName">Loading...</h5>
                                <button class="logout-btn" onclick="logout()">Logout</button>
                            </div>
                            <div class="reputation-display">
                                <span class="star-rating" id="starDisplay">*****</span>
                                <span id="ratingText">4.5 (12 ratings)</span>
                            </div>
                        </div>
                        <div class="account-section">
                            <h6>Outstanding Requests</h6>
                            <div class="loading-spinner" id="bidsLoading">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <span class="ms-2">Loading requests...</span>
                            </div>
                            <div id="outstandingBids">
                                <p class="text-muted mb-0">No outstanding requests</p>
                            </div>
                        </div>
                        <div class="account-section">
                            <h6>Active Services</h6>
                            <div class="loading-spinner" id="activeJobsLoading">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <span class="ms-2">Loading active services...</span>
                            </div>
                            <div id="activeJobs">
                                <p class="text-muted mb-0">No active services</p>
                            </div>
                        </div>
                        <div class="account-section">
                            <h6>Recent Completed Services</h6>
                            <div class="loading-spinner" id="jobsLoading">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <span class="ms-2">Loading services...</span>
                            </div>
                            <div id="completedJobs">
                                <p class="text-muted mb-0">No completed services</p>
                            </div>
                        </div>
                    </div>
                </div>
                <button id="loginButton" class="btn btn-light ms-3" onclick="showAuth()">Get Started</button>
            </div>
        </div>
    </nav>

    <header style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px 0; margin-bottom: 30px;">
        <div class="container">
            <h1 style="color: white; text-shadow: 0 2px 6px rgba(0,0,0,0.3);">RSE Activity Dashboard</h1>
            <p class="lead" style="color: white;">Real-time exchange data and nearby services</p>
        </div>
    </header>
    
    <main>
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <!-- Map -->
                    <div class="map-container" style="height: 600px; position: relative;">
                        <div id="map" style="width: 100%; height: 100%;"></div>
                        <div class="map-controls" style="position: absolute; top: 10px; left: 10px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <label><input type="checkbox" id="show-active-bids" checked> Show Active Bids (Blue)</label><br>
                            <label><input type="checkbox" id="show-completed-jobs" checked> Show Completed (Green)</label>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <!-- Simulated Traffic Toggle -->
                    <div class="simulation-toggle">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="simulationToggle">
                            <label class="form-check-label" for="simulationToggle">
                                Enable Simulated Traffic Demo
                            </label>
                        </div>
                        <small class="text-muted">Shows fake activity for demonstration purposes</small>
                    </div>

                    <!-- Real Exchange Statistics -->
                    <div class="real-data-section">
                        <h5>Exchange Stats <span class="real-badge">LIVE DATA</span></h5>
                        <div class="loading-spinner" id="statsLoading">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <p>Loading statistics...</p>
                        </div>
                        <div id="exchangeStats" style="display: none;">
                            <div class="stat-card">
                                <div class="stat-number" id="activeBidsCount">-</div>
                                <div class="stat-label">Active Bids</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="completedTodayCount">-</div>
                                <div class="stat-label">Completed Today</div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <h6>Active Bid Details</h6>
                            <textarea id="activeBidsDetails" class="form-control" rows="6" readonly style="font-size: 0.85rem; background-color: #f8f9fa;"></textarea>
                        </div>
                    </div>

                    <!-- Recent Real Activity -->
                    <div class="real-data-section mt-3">
                        <h5>Recent Activity <span class="real-badge">LIVE</span></h5>
                        <div class="loading-spinner" id="activityLoading">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <p>Loading activity...</p>
                        </div>
                        <div id="recentActivity" style="display: none; max-height: 250px; overflow-y: auto;">
                        </div>
                    </div>

                    <!-- Simulated Activity Section (hidden by default) -->
                    <div class="simulated-section" id="simulatedSection" style="display: none;">
                        <h5>Simulated Activity <span class="simulation-badge">DEMO ONLY</span></h5>
                        <p class="text-muted small">This is fake data for demonstration purposes. Not from the real exchange.</p>
                        <div id="simulated-activity-log"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5>The Service Exchange</h5>
                    <p>Decentralized marketplace for services.</p>
                </div>
                <div class="col-md-4">
                    <h5>Links</h5>
                    <a href="index.html">Home</a>
                    <a href="api_docs.html">API Documentation</a>
                </div>
                <div class="col-md-4">
                    <h5>Connect</h5>
                    <a href="https://x.com/RobotServicesX">Twitter</a>
                    <a href="https://github.com/mickeyshaughnessy/theservicesexchange">GitHub</a>
                </div>
            </div>
            <div class="mt-5 pt-4 border-top border-secondary text-center">
                <p class="mb-0">&copy; 2025 The Service Exchange Protocol. All rights reserved.</p>
            </div>
        </div>
    </footer>
    
    <div class="modal fade" id="authModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Get Started</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="authError" class="error-message" style="display: none;"></div>
                    <ul class="nav nav-tabs mb-3">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#login">Login</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#register">Register</a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane active" id="login">
                            <form id="loginForm">
                                <div class="mb-3">
                                    <input type="text" class="form-control" placeholder="Username" id="loginUsername" required>
                                </div>
                                    <div class="mb-3">
                                    <input type="password" class="form-control" placeholder="Password" id="loginPassword" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100" id="loginSubmitBtn">Login</button>
                            </form>
                        </div>
                        <div class="tab-pane" id="register">
                            <form id="registerForm">
                                <div class="mb-3">
                                    <input type="text" class="form-control" placeholder="Username" id="regUsername" required>
                                </div>
                                <div class="mb-3">
                                    <input type="password" class="form-control" placeholder="Password (min 8 chars)" id="regPassword" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100" id="registerSubmitBtn">Register</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="chatModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Inbox</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-4">
                            <h6>Conversations</h6>
                            <div class="chat-inbox" id="chatInbox">
                                <div class="loading-spinner" id="conversationsLoading">
                                    <div class="spinner-border spinner-border-sm" role="status"></div>
                                    <span class="ms-2">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-8">
                            <div id="conversationView" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 id="currentConversationUser">Select a conversation</h6>
                                    <button class="btn btn-sm btn-primary" onclick="showNewMessageForm()">New Message</button>
                                </div>
                                <div class="message-history" id="messageHistory"></div>
                                <form id="replyForm" style="display: none;">
                                    <div class="input-group">
                                        <input type="text" class="form-control" placeholder="Type your reply..." id="replyMessage" required>
                                        <button type="submit" class="btn btn-primary">Send</button>
                                    </div>
                                </form>
                            </div>
                            <div id="newMessageForm" style="display: none;">
                                <h6>New Message</h6>
                                <form id="chatForm">
                                    <div class="mb-3">
                                        <input type="text" class="form-control" placeholder="Recipient username" id="chatRecipient" required>
                                    </div>
                                    <div class="mb-3">
                                        <textarea class="form-control" rows="3" placeholder="Your message" id="chatMessage" required></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <input type="text" class="form-control" placeholder="Job ID (optional)" id="chatJobId">
                                        <small class="text-muted">Link this message to a specific job</small>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary">Send Message</button>
                                        <button type="button" class="btn btn-secondary" onclick="hideNewMessageForm()">Cancel</button>
                                    </div>
                                </form>
                            </div>
                            <div id="chatPlaceholder">
                                <div class="text-center text-muted p-4">
                                    <p>Select a conversation to view messages or click "New Message" to start chatting.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="bulletinModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Community Bulletin</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>Recent Posts</h6>
                        <button class="btn btn-sm btn-primary" onclick="showNewPostForm()">New Post</button>
                    </div>
                    <div id="bulletinFeed" class="bulletin-feed">
                        <div class="loading-spinner" id="bulletinLoading">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <span class="ms-2">Loading posts...</span>
                        </div>
                    </div>
                    <div id="newPostForm" style="display: none;" class="mt-3 p-3 border rounded">
                        <h6>Create New Post</h6>
                        <form id="bulletinForm">
                            <div class="mb-3">
                                <input type="text" class="form-control" placeholder="Post title" id="bulletinTitle" required>
                            </div>
                            <div class="mb-3">
                                <select class="form-control" id="bulletinCategory">
                                    <option value="general">General</option>
                                    <option value="announcement">Announcement</option>
                                    <option value="question">Question</option>
                                    <option value="offer">Service Offer</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <textarea class="form-control" rows="4" placeholder="Post content" id="bulletinContent" required></textarea>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">Post to Bulletin</button>
                                <button type="button" class="btn btn-secondary" onclick="hideNewPostForm()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="script.js"></script>
    <script>
        // Mapbox access token
        mapboxgl.accessToken = 'pk.eyJ1IjoibWlja2V5c2hhdWdobmVzc3kiLCJhIjoiY2x6NGxyNG93MnptaDJxb2dhOGloenZqeiJ9.ANY7UIu7VTPFwqTD8cEAKQ';

        // State
        let map = null;
        let realMarkers = [];
        let simulatedMarkers = [];
        let simulationInterval = null;
        let simulationEnabled = false;

        // Marker colors
        const markerColors = {
            activeBid: '#3b82f6',     // blue for active bids
            completed: '#10b981',     // green for completed
            simulated: '#f59e0b'      // orange/amber for simulated
        };

        // Service requests for simulation
        const serviceRequests = [
            "Aerial photography of solar farm",
            "Autonomous lawn mowing for golf course",
            "Underwater pipeline inspection",
            "Rooftop HVAC maintenance",
            "Traffic flow optimization",
            "Agricultural crop spraying",
            "Search and rescue in wilderness",
            "Warehouse inventory management",
            "Construction site surveying",
            "Automated parking assistance",
            "Wildlife population monitoring",
            "Waste sorting and recycling",
            "Building facade cleaning",
            "Autonomous security patrol",
            "Tree health assessment in urban areas",
            "Package delivery to remote locations",
            "Automated harvesting of fruits",
            "Snow removal from solar panels",
            "Disaster area assessment",
            "Underground utility mapping",
            "Autonomous grocery delivery to residential areas",
            "Robotic meal kit preparation and delivery",
            "Drone-based fast food delivery",
            "Automated fresh produce distribution",
            "Contactless restaurant order pickup and delivery"
        ];

        const robotNames = [
            "SkyEye-X1", "TurfMaster 3000", "AquaProbe Delta", "ClimboCraft Pro", "UrbanFlow AI",
            "CropCare Quad", "WildernessScout", "StockBot Express", "GeoMapper Plus", "ParkAssist 2.0",
            "EcoTracker", "RecycleMatic", "SkyWash Ultra", "SecuriGuard X3", "ArborHealth Scanner"
        ];

        // Initialize the map
        function initializeMap() {
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v11',
                center: [-104.9903, 39.7392],
                zoom: 12
            });

            map.addControl(new mapboxgl.NavigationControl());

            // Try to center on user's location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLat = position.coords.latitude;
                        const userLon = position.coords.longitude;
                        map.flyTo({center: [userLon, userLat], zoom: 13});
                        new mapboxgl.Marker({color: '#ef4444'})
                            .setLngLat([userLon, userLat])
                            .setPopup(new mapboxgl.Popup().setHTML('<p>You are here</p>'))
                            .addTo(map);
                    },
                    (error) => {
                        console.warn(`Geolocation error (${error.code}): ${error.message}`);
                    }
                );
            }

            map.on('load', () => {
                loadExchangeData();
                loadExchangeDataOnMap();
            });
        }

        // Load real exchange data
        async function loadExchangeData() {
            const statsLoading = document.getElementById('statsLoading');
            const activityLoading = document.getElementById('activityLoading');
            
            if (statsLoading) statsLoading.style.display = 'block';
            if (activityLoading) activityLoading.style.display = 'block';
            
            try {
                const response = await fetch(`${API_URL}/exchange_data?limit=50&include_completed=true`);
                
                if (response.ok) {
                    const data = await response.json();
                    updateExchangeStats(data);
                    updateRecentActivity(data);
                } else {
                    console.error('Failed to load exchange data');
                }
            } catch (error) {
                console.error('Error loading exchange data:', error);
            } finally {
                if (statsLoading) {
                    statsLoading.style.display = 'none';
                    const exchangeStats = document.getElementById('exchangeStats');
                    if (exchangeStats) exchangeStats.style.display = 'block';
                }
                if (activityLoading) {
                    activityLoading.style.display = 'none';
                    const recentActivity = document.getElementById('recentActivity');
                    if (recentActivity) recentActivity.style.display = 'block';
                }
            }
        }

        // Load real data onto map
        async function loadExchangeDataOnMap() {
            try {
                const categoryFilter = document.getElementById('categoryFilter');
                const locationFilter = document.getElementById('locationFilter');
                const limitFilter = document.getElementById('limitFilter');
                const includeCompleted = document.getElementById('includeCompleted');
                
                const params = new URLSearchParams();
                if (categoryFilter && categoryFilter.value) params.append('category', categoryFilter.value);
                if (locationFilter && locationFilter.value) params.append('location', locationFilter.value);
                if (limitFilter && limitFilter.value) params.append('limit', limitFilter.value);
                if (includeCompleted) params.append('include_completed', includeCompleted.checked);
                
                const response = await fetch(`${API_URL}/exchange_data?${params.toString()}`);
                
                if (response.ok) {
                    const data = await response.json();
                    displayRealServicesOnMap(data);
                } else {
                    console.error('Failed to load exchange data for map');
                }
            } catch (error) {
                console.error('Error loading exchange data for map:', error);
            }
        }

        // Display real services on map
        async function displayRealServicesOnMap(data) {
            clearRealMarkers();
            
            const showActiveBids = document.getElementById('show-active-bids')?.checked ?? true;
            const showCompleted = document.getElementById('show-completed-jobs')?.checked ?? true;
            
            const activeBids = showActiveBids ? (data.active_bids || []) : [];
            const completedJobs = showCompleted ? (data.completed_jobs || []) : [];
            
            const allJobs = [...activeBids.map(j => ({...j, isCompleted: false})), 
                           ...completedJobs.map(j => ({...j, isCompleted: true}))];
            
            for (const job of allJobs) {
                let lat = job.lat;
                let lon = job.lon;
                
                if ((!lat || !lon) && job.address) {
                    try {
                        const coords = await geocodeAddress(job.address);
                        if (coords) {
                            lat = coords.lat;
                            lon = coords.lon;
                        }
                    } catch (error) {
                        console.warn(`Failed to geocode address: ${job.address}`, error);
                    }
                }
                
                if (lat && lon) {
                    const service = typeof job.service === 'string' ? job.service : 
                                  (job.service?.type || 'Service');
                    
                    const popup = new mapboxgl.Popup({ offset: 25 }).setHTML(`
                        <div style="padding: 10px;">
                            <h6>${service}</h6>
                            <p><strong>$${job.price}</strong> ${job.isCompleted ? '- Completed' : '- Active Bid'}</p>
                            ${job.address || job.location ? `<p class="text-muted small">${job.address || job.location}</p>` : ''}
                            <span class="badge bg-success">REAL DATA</span>
                        </div>
                    `);
                    
                    const markerColor = job.isCompleted ? markerColors.completed : markerColors.activeBid;
                    
                    const marker = new mapboxgl.Marker({color: markerColor})
                        .setLngLat([lon, lat])
                        .setPopup(popup)
                        .addTo(map);
                    
                    realMarkers.push(marker);
                }
            }
        }

        // Update exchange stats
        function updateExchangeStats(data) {
            const stats = data.market_stats || {};
            
            const activeBidsCount = document.getElementById('activeBidsCount');
            const completedTodayCount = document.getElementById('completedTodayCount');
            const activeBidsDetails = document.getElementById('activeBidsDetails');
            
            if (activeBidsCount) activeBidsCount.textContent = stats.total_active_bids || 0;
            if (completedTodayCount) completedTodayCount.textContent = stats.total_completed_today || 0;
            
            if (activeBidsDetails) {
                const activeBids = data.active_bids || [];
                if (activeBids.length === 0) {
                    activeBidsDetails.value = 'No active bids available.';
                } else {
                    const bidDetails = activeBids.map((bid, index) => {
                        const service = typeof bid.service === 'string' ? bid.service : 
                                      (bid.service?.type || 'Service');
                        const location = bid.address || bid.location || 'No address specified';
                        const postedDate = bid.posted_at ? new Date(bid.posted_at * 1000).toLocaleString() : 'N/A';
                        
                        return `Bid #${index + 1}:\nService: ${service}\nPrice: $${bid.price}\nLocation: ${location}\nPosted: ${postedDate}\n${bid.buyer_reputation ? `Rating: ${bid.buyer_reputation.toFixed(1)} stars` : 'No rating'}\n`;
                    }).join('\n---\n\n');
                    
                    activeBidsDetails.value = bidDetails;
                }
            }
        }

        // Update recent activity
        function updateRecentActivity(data) {
            const container = document.getElementById('recentActivity');
            if (!container) return;
            
            const activeBids = data.active_bids || [];
            const completedJobs = data.completed_jobs || [];
            
            const allActivity = [
                ...activeBids.map(bid => ({...bid, type: 'bid', date: bid.posted_at})),
                ...completedJobs.map(job => ({...job, type: 'completed', date: job.completed_at}))
            ].sort((a, b) => b.date - a.date).slice(0, 10);
            
            if (allActivity.length === 0) {
                container.innerHTML = '<p class="text-muted">No recent activity</p>';
                return;
            }
            
            container.innerHTML = allActivity.map(item => {
                const isCompleted = item.type === 'completed';
                const service = typeof item.service === 'string' ? item.service : 
                              (item.service?.type || 'Service');
                
                return `
                    <div class="job-item ${isCompleted ? 'job-completed' : ''}">
                        <div class="job-title">${service}</div>
                        <div class="job-meta">
                            $${item.price} - ${isCompleted ? 'Completed' : 'Active Bid'} - 
                            ${new Date(item.date * 1000).toLocaleDateString()}
                        </div>
                        ${item.location ? `<div class="job-meta">${item.location}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Clear real markers
        function clearRealMarkers() {
            realMarkers.forEach(marker => marker.remove());
            realMarkers = [];
        }

        // Clear simulated markers
        function clearSimulatedMarkers() {
            simulatedMarkers.forEach(marker => marker.remove());
            simulatedMarkers = [];
        }

        // Geocode address
        async function geocodeAddress(address) {
            try {
                const response = await fetch(
                    `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?access_token=${mapboxgl.accessToken}&limit=1`
                );
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.features && data.features.length > 0) {
                        const [lon, lat] = data.features[0].center;
                        return { lat, lon };
                    }
                }
                return null;
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        }

        // SIMULATION FUNCTIONS
        function getRandomLocation() {
            const bounds = map.getBounds();
            const sw = bounds.getSouthWest();
            const ne = bounds.getNorthEast();
            const lat = Math.random() * (ne.lat - sw.lat) + sw.lat;
            const lon = Math.random() * (ne.lng - sw.lng) + sw.lng;
            return [lat, lon];
        }

        function addSimulatedActivity() {
            if (!simulationEnabled) return;
            
            const activityLog = document.getElementById('simulated-activity-log');
            const [lat, lon] = getRandomLocation();
            const timestamp = new Date().toLocaleTimeString();
            
            const rand = Math.random();
            let logEntry, popupContent;
            
            if (rand < 0.5) {
                const service = serviceRequests[Math.floor(Math.random() * serviceRequests.length)];
                logEntry = `[${timestamp}] Service: ${service}`;
                popupContent = `<div style="padding: 8px;"><h6>Service Request</h6><p>${service}</p><span class="badge" style="background: #f59e0b;">SIMULATED</span></div>`;
            } else {
                const robot = robotNames[Math.floor(Math.random() * robotNames.length)];
                logEntry = `[${timestamp}] Robot: ${robot}`;
                popupContent = `<div style="padding: 8px;"><h6>Robot Location</h6><p>${robot}</p><span class="badge" style="background: #f59e0b;">SIMULATED</span></div>`;
            }
            
            // Add log entry
            const logItem = document.createElement('div');
            logItem.textContent = logEntry;
            activityLog.appendChild(logItem);
            activityLog.scrollTop = activityLog.scrollHeight;
            
            if (activityLog.children.length > 50) {
                activityLog.removeChild(activityLog.firstChild);
            }
            
            // Add marker
            const popup = new mapboxgl.Popup({ offset: 25 }).setHTML(popupContent);
            const marker = new mapboxgl.Marker({color: markerColors.simulated})
                .setLngLat([lon, lat])
                .setPopup(popup)
                .addTo(map);
            
            simulatedMarkers.push(marker);
            
            if (simulatedMarkers.length > 50) {
                simulatedMarkers.shift().remove();
            }
        }

        function startSimulation() {
            simulationEnabled = true;
            document.getElementById('simulatedSection').style.display = 'block';
            simulationInterval = setInterval(addSimulatedActivity, 2000);
        }

        function stopSimulation() {
            simulationEnabled = false;
            document.getElementById('simulatedSection').style.display = 'none';
            if (simulationInterval) {
                clearInterval(simulationInterval);
                simulationInterval = null;
            }
            clearSimulatedMarkers();
            document.getElementById('simulated-activity-log').innerHTML = '';
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            initializeMap();
            
            // Simulation toggle
            const simulationToggle = document.getElementById('simulationToggle');
            if (simulationToggle) {
                simulationToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        startSimulation();
                    } else {
                        stopSimulation();
                    }
                });
            }
            
            // Filter form
            const filterForm = document.getElementById('filterForm');
            if (filterForm) {
                filterForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    if (map) {
                        loadExchangeDataOnMap();
                    }
                });
            }
            
            // Checkbox filters
            document.getElementById('show-active-bids')?.addEventListener('change', () => loadExchangeDataOnMap());
            document.getElementById('show-completed-jobs')?.addEventListener('change', () => loadExchangeDataOnMap());
            document.getElementById('includeCompleted')?.addEventListener('change', () => loadExchangeDataOnMap());
        });
    </script>
</body>
</html>
